# آلية المحادثات بين الأدوار — كيف تعمل وكيف نضبطها

## الأدوار المعنية

| الدور | الوصف | من يرى المحادثات |
|-------|--------|-------------------|
| **صاحب المكان (Owner)** | من أنشأ المكان (`place.user_id`) | كل الرسائل المرتبطة بأماكنه (حسب `place_id`) + رسائله المرسلة |
| **العميل/الزائر (Client)** | أي مستخدم يرسل رسالة لمكان (ليس صاحبه ولا موظف) | الرسائل التي **هو مستقبلها** (`recipient_id = أنا`) + ما أرسله |
| **الموظف (Employee)** | مسجل في `place_employees` للمكان | نفس منطق العميل إذا كان يرد من واجهة الزائر، أو قد يُربط بـ `employee_id` في الرسالة |

---

## جدول الرسائل (messages)

الحقول الأساسية للمحادثات:

| الحقل | المعنى |
|-------|--------|
| `place_id` | المحادثة دائماً مرتبطة بمكان واحد |
| `sender_id` | من أرسل الرسالة (user id) |
| `recipient_id` | من يستقبل الرسالة (user id). يُملأ عند وجود محادثة 1-1 واضحة |
| `employee_id` | إن أُرسلت نيابة عن الموظف (اختياري) |
| `content`, `image_url`, `audio_url`, `product_id`, `reply_to`, `is_read` | محتوى الرسالة وحالتها |

- **محادثة واحدة** = كل الرسائل بين **شخصين** في **مكان واحد** (تحديد الشريك: إما `sender_id` أو `recipient_id` حسب من أنا).

---

## مصدران للرسائل في الواجهة

يوجد **مصدران** لتحميل وعرض المحادثات:

### 1) صفحة المكان `app/places/[id]/page.tsx`

- **الهوك:** `useMessages({ placeId, autoLoad: true })`
- **ما يُحمّل:** كل الرسائل التي `place_id = هذا المكان` (بدون فلتر حسب المستخدم).
- **كيف تُجمَّع المحادثات (محلياً في الصفحة):**
  - `getConversations()`: يعتبر "محادثة" = كل الرسائل التي **المرسل فيها ليس أنا**، ويُجمّع حسب `sender_id` (كل مرسل = محادثة).
  - الشريك في المحادثة = `sender_id` للطرف الآخر.
  - عند الإرسال: يُحسب `recipient_id` كالتالي:
    - إن وُجدت محادثة محددة: `recipient_id = selectedConversation` (الشريك).
    - إن كان الرد على رسالة: `recipient_id = reply.sender_id`.
    - إن كان زائر يرسل لمكان: `recipient_id = place.user_id` (صاحب المكان).
- **النتيجة:** على صفحة مكان واحد ترى كل المحادثات الخاصة بهذا المكان فقط، والمحادثة = كل تبادل مع شخص معين (حسب المرسل عند التجميع).

### 2) الشريط الجانبي للمحادثات + صفحة الرسائل

- **الهوك:** `useConversationsManager({ userId, userPlaces })`
- **ما يُحمّل (ثلاث استعلامات):**
  1. **رسائل صاحب المكان:** كل الرسائل التي `place_id` ضمن `userPlaces` (أماكن المستخدم).
  2. **رسائل كعميل:** كل الرسائل التي `recipient_id = userId`.
  3. **رسائلي المرسلة:** كل الرسائل التي `sender_id = userId`.
- **كيف تُجمَّع المحادثات:**
  - في `getConversations()`: التجميع حسب **المكان** ثم حسب **الشريك**.
  - الشريك:
    - إن أنا المرسل: `partnerId = recipient_id`.
    - إن أنا المستقبل أو طرف ثالث: `partnerId = sender_id`.
  - مفتاح المحادثة: `partnerId + placeId` (شخص واحد + مكان واحد = محادثة واحدة).
- **أين يُستخدم:** `ConversationsSidebar.tsx` و `app/messages/page.tsx`.

---

## تدفق المحادثات حسب الدور

### صاحب المكان (Owner)

1. يدخل على صفحة مكانه أو يفتح **الشريط الجانبي للمحادثات** أو **صفحة الرسائل**.
2. يرى قائمة محادثات: كل عنصر = شريك (عميل/زائر أو موظف) + مكان.
3. الرسائل تُجلب من:
   - رسائل أماكنه (حسب `place_id in userPlaces`)،
   - ورسائله المرسلة (حسب `sender_id = userId`).
4. عند الرد: `sender_id = أنا` و `recipient_id = الشريك`.

### العميل/الزائر (Client)

1. يدخل على صفحة مكان (ليس ملكه) ويضغط "إرسال رسالة" أو يفتح المحادثات من نفس الصفحة.
2. الرسائل تُجلب في صفحة المكان عبر `useMessages(placeId)` (كل رسائل هذا المكان)، أو في صفحة الرسائل/الشريط عبر `useConversationsManager` (ما يكون `recipient_id = أنا` أو `sender_id = أنا`).
3. عند الإرسال من صفحة المكان: `sender_id = أنا` و `recipient_id = place.user_id` (صاحب المكان).

### الموظف (Employee)

- إن كان يرد من واجهة الزائر (صفحة المكان): يُعامل مثل العميل؛ قد يُخزَّن اختيارياً `employee_id` في الرسالة إن وُجدت واجهة "رد نيابة عن المكان".
- في `useConversationsManager` يمكن تمييز محادثات مرتبطة بموظف عبر `employee_id` أو عبر الشريك (الموظف = شريك في المحادثة).

---

## ما يمكن ضبطه (للمراجعة والتعديل)

### 1) توحيد مصدري المحادثات

- **الوضع الحالي:** صفحة المكان تعتمد `useMessages` + منطق محلي (`getConversations` / `getConversationMessages`)، بينما الشريط وصفحة الرسائل تعتمد `useConversationsManager`.
- **الضبط المقترح:**
  - إما استخدام `useConversationsManager` أيضاً في صفحة المكان (مع `placeId` محدد إن لزم) ليكون منطق "من هو الشريك؟" و"ما الذي يُعرض؟" واحداً في كل الواجهة.
  - أو الإبقاء على الفصل لكن توثيق واضح أن صفحة المكان = "محادثات هذا المكان فقط" والـ Manager = "كل محادثاتي عبر كل الأماكن".

### 2) تحديد الشريك في صفحة المكان

- **الحالي:** التجميع حسب `sender_id` فقط (من أرسل لي = شريك).
- **إن أردت تمييز "أنا أرسلت له" بشكل صريح:** يمكن في `getConversationMessages` أو عند التجميع استخدام شرط مثل:  
  `(msg.sender_id === partnerId || msg.recipient_id === partnerId)` حتى لا تُخلط محادثتان لشخص واحد في مكان واحد (نادر لكن ممكن نظرياً).

### 3) الموظف وـ employee_id

- **الحالي:** `employee_id` موجود في الجدول وفي الهوك (مثلاً عند الإرسال من الشريط).
- **الضبط:** التأكد أن أي واجهة "رد كموظف" تملأ `employee_id` عند الإرسال، وأن عرض المحادثات في صفحة الموظف أو صاحب المكان يوضح إن كانت الرسالة "من الموظف" أم من صاحب المكان.

### 4) Real-time

- **useMessages:** يشترك في التغييرات على `messages` حسب `place_id` (قناة واحدة للمكان).
- **useConversationsManager:** يشترك في قنوات متعددة (رسائل أماكني، رسائلي المستقبلة، رسائلي المرسلة).
- **الضبط:** التأكد أن أي إدراج/تحديث لرسالة (مثلاً من صفحة المكان) يظهر فوراً في الشريط وصفحة الرسائل إن كانت الاشتراكات تغطي نفس الصفوف.

### 5) صفحة الرسائل `app/messages/page.tsx`

- تعتمد `getConversations()` من `useConversationsManager` وتعرض قائمة محادثات (مكان + شريك).
- عند النقر على محادثة: التوجيه إلى `router.push(\`/places/${conv.placeId}\`)` (بدون تمرير الشريك في الـ URL حالياً).
- **الضبط:** إن أردت فتح المحادثة مباشرة مع الشريك المحدد، يمكن إضافة query مثل `?conversation=userId` أو `?openConversation=userId` وقراءتها في صفحة المكان لتعيين `selectedConversation` تلقائياً.

---

## ملخص سريع

| العنصر | صفحة المكان | الشريط / صفحة الرسائل |
|--------|------------|------------------------|
| الهوك | `useMessages(placeId)` | `useConversationsManager(userId, userPlaces)` |
| نطاق الرسائل | مكان واحد | كل أماكني + كل ما أرسلته/استقبلته |
| تعريف "محادثة" | نفس المكان + نفس المرسل (sender_id) | نفس المكان + نفس الشريك (sender أو recipient) |
| إرسال | insert مع `recipient_id` (شريك أو صاحب المكان) | نفس الفكرة عبر الـ Manager |

لضبط السلوك: ركّز على (1) من يعتبر "شريك" في كل واجهة، (2) هل تريد توحيد الهوكين أم إبقاء الفصل مع توثيق واضح، (3) تمرير معامل المحادثة (الشريك) من صفحة الرسائل إلى صفحة المكان إن لزم.
