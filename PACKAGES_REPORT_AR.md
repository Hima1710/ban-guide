# تقرير الباقات وإدارتها — BANV1

**التاريخ:** 29 يناير 2026  
**النطاق:** إدارة الباقات من جانب المدير، واختيار العملاء للباقات المناسبة

---

## 1. نظرة عامة

نظام الباقات يحدد **ماذا يحصل عليه العميل** عند الاشتراك (عدد الأماكن، صور/فيديوهات المنتجات، ظهور مميز، إلخ)، ويربط بين:
- **المدير:** تعريف وتعديل الباقات (CRUD) عبر لوحة الإدارة.
- **العميل:** عرض الباقات، اختيار باقة، رفع إيصال، انتظار الموافقة.
- **التطبيق:** ربط الاشتراك بالمكان (`places.subscription_id`) وتحديد حدود الباقة (عدد الأماكن، عدد الصور/الفيديوهات) وظهور البطاقات في التغذية حسب المستوى (Premium / Gold / Basic).

---

## 2. نموذج البيانات (Data Model)

### 2.1 جدول `packages`

| الحقل | النوع | الوصف |
|--------|--------|--------|
| `id` | UUID | المعرف |
| `name_ar` | string | الاسم بالعربية |
| `name_en` | string | الاسم بالإنجليزية |
| `price` | number | السعر (EGP) |
| `max_places` | number | الحد الأقصى لعدد الأماكن |
| `max_product_videos` | number | فيديوهات لكل منتج |
| `max_product_images` | number | صور لكل منتج |
| `max_place_videos` | number | فيديوهات للمكان |
| `priority` | number | أولوية الظهور (أعلى = أفضل) |
| `card_style` | string | نمط البطاقة: `default` \| `silver` \| `gold` \| `premium` |
| `is_featured` | boolean | باقة مميزة (ظهور مميز في الصفحة الرئيسية) |
| `created_at` / `updated_at` | timestamp | |

- **المصدر في الكود:** `lib/types.ts` (واجهة `Package`).
- **هجرات إضافية:** `complete_schema_migration.sql` يضيف أعمدة اختيارية: `is_featured`, `sort_order`, `icon`.

### 2.2 جدول `user_subscriptions`

يربط المستخدم بباقة معينة بعد الموافقة على الدفع.

| الحقل | الوصف |
|--------|--------|
| `id` | معرف الاشتراك |
| `user_id` | المستخدم |
| `package_id` | الباقة |
| `amount_paid` | المبلغ المدفوع |
| `expires_at` | تاريخ انتهاء الاشتراك |
| `receipt_image_url` | رابط صورة إيصال الدفع |
| `status` | `pending` \| `approved` \| `rejected` |
| `is_active` | تفعيل بعد موافقة المدير |

- **الهجرة:** `add_receipt_to_subscriptions.sql` يضيف `receipt_image_url` و `status`.

### 2.3 ربط الأماكن بالاشتراك

- **جدول `places`:**
  - `subscription_id`: يشير إلى سجل في `user_subscriptions`.
- عند **إنشاء مكان جديد** (`app/dashboard/places/new/page.tsx`):
  - يُتحقق من وجود اشتراك نشط للمستخدم.
  - يُتحقق من عدم تجاوز `max_places` للباقة.
  - يُدرج المكان مع `subscription_id: subscription.id` و `is_featured` من الباقة إن وُجد.

بهذا الشكل، كل مكان مرتبط بباقة واحدة، ويُستخدم هذا الربط في التغذية الموحدة لتمييز مستوى البطاقة (Premium / Gold / Basic).

---

## 3. إدارة الباقات من جانب المدير

### 3.1 الصفحة والوصول

- **المسار:** `/admin/packages`
- **الصلاحية:** مستخدم لديه `user_profiles.is_admin = true` فقط.
- **المصدر:** `app/admin/packages/page.tsx`

### 3.2 الهوك المستخدم

يتم الاعتماد على **`useAdminManager`** (`hooks/useAdminManager.ts`) مع `autoLoadPackages: true`:

- `packages`: قائمة الباقات (مرتبة حسب `priority` تنازلياً).
- `packagesLoading`: حالة التحميل.
- `createPackage(formData)`: إضافة باقة.
- `updatePackage(id, formData)`: تعديل باقة.
- `deletePackage(id)`: حذف باقة.

جميع العمليات تتم عبر Supabase من الهوك؛ الصفحة لا تستدعي Supabase مباشرة.

### 3.3 واجهة المدير

1. **قائمة الباقات:** جدول يعرض (الاسم عربي/إنجليزي، السعر، عدد الأماكن، الأولوية) مع أزرار تعديل وحذف.
2. **نموذج إضافة/تعديل باقة:**
   - الاسم (عربي، إنجليزي).
   - السعر، عدد الأماكن، الأولوية.
   - حدود المحتوى: فيديوهات المنتج، صور المنتج، فيديوهات المكان.
   - **نمط الكارت:** قائمة منسدلة: افتراضي، فضي، ذهبي، مميز.
   - **باقة مميزة:** خانة اختيار (تظهر في الأعلى / ظهور مميز في الصفحة الرئيسية).

### 3.4 قيم `card_style` وتأثيرها

- في **لوحة المدير:** الخيارات هي `default` | `silver` | `gold` | `premium`.
- في **التغذية الموحدة** (`useUnifiedFeed.ts`): يتم اشتقاق `tier` (Premium / Gold / Basic) من `priority` و `card_style` و `is_featured` لعرض البطاقات بمستويات مختلفة في الواجهة.

---

## 4. اختيار العملاء للباقات

### 4.1 الصفحة والوصول

- **المسار:** `/dashboard/packages`
- **المصدر:** `app/dashboard/packages/page.tsx`
- **الشرط:** مستخدم مسجل دخول (يُحوَّل غير المسجل إلى تسجيل الدخول).

### 4.2 تدفق العميل

1. **تحميل الباقات:** استعلام من `packages` مع ترتيب: `priority` تنازلي ثم `price` تصاعدي.
2. **الاشتراك الحالي:** استعلام من `user_subscriptions` حيث `user_id = current user` و `is_active = true`؛ إن وُجد يعرض اسم الباقة وتاريخ الانتهاء ويمنع اشتراكاً ثانياً.
3. **كود الخصم (اختياري):**
   - البحث في `discount_codes` (كود نشط ضمن الفترة وعدد الاستخدامات).
   - إن لم يُوجد، البحث في `affiliates` بنفس الكود.
   - عند التطبيق يُحسب السعر النهائي بعد الخصم.
4. **اختيار باقة والاشتراك:**
   - العميل يضغط "اشترك الآن" → يفتح نافذة رفع إيصال الدفع.
   - إلزامي: رفع صورة إيصال (عبر `/api/upload-image`).
   - إنشاء سجل في `user_subscriptions`:
     - `status: 'pending'`, `is_active: false`.
     - `receipt_image_url`, `amount_paid`, `expires_at` (مثلاً بعد 30 يوم).
   - إن وُجد خصم (كود أو تابع): تحديث `used_count` للكود أو إنشاء `affiliate_transactions` حسب النوع.
5. **بعد الحفظ:** رسالة نجاح للمستخدم، وإغلاق النافذة، وتحديث عرض الاشتراك الحالي (يبقى "قيد المراجعة" حتى يوافق المدير).

### 4.3 عرض الباقات للعميل

- الباقات تظهر في شبكة (كروت) مع:
  - الاسم (عربي/إنجليزي)، السعر (مع السعر بعد الخصم إن وُجد).
  - قائمة مميزات: عدد الأماكن، صور/فيديوهات المنتج، فيديوهات المكان، و"ظهور مميز" للباقات المميزة.
- تمييز بصري حسب `card_style` و `is_featured` (حدود، ألوان، شارة "مميز").
- تعطيل زر الاشتراك إذا كان المستخدم لديه اشتراك نشط أو إذا الباقة هي الحالية.

---

## 5. مراجعة الاشتراكات (المدير)

### 5.1 الصفحة

- **المسار:** `/admin/subscriptions`
- **المصدر:** `app/admin/subscriptions/page.tsx`

### 5.2 الوظائف

- عرض كل الاشتراكات مع: المستخدم، الباقة، المبلغ، الحالة، إيصال (مع عرض الصورة).
- **موافقة:** تحديث السجل إلى `status: 'approved'`, `is_active: true`.
- **رفض:** تحديث إلى `status: 'rejected'`, `is_active: false`.

بعد الموافقة يصبح بإمكان العميل استخدام الباقة (إضافة أماكن ضمن حدود `max_places` وربطها بـ `subscription_id` عند إنشاء المكان).

---

## 6. ربط الباقات بالأماكن والتغذية

### 6.1 إنشاء مكان جديد

- في `app/dashboard/places/new/page.tsx`:
  - التحقق من اشتراك نشط واحد على الأقل للمستخدم.
  - التحقق من أن عدد أماكن المستخدم الحالية &lt; `max_places` للباقة.
  - عند الإدراج: `subscription_id: subscription.id`, `is_featured` من الباقة إن وُجد.

### 6.2 حدود الباقة على المحتوى

- في `app/dashboard/places/[id]/products/new/page.tsx`: يتم جلب الباقة عبر `places.subscription_id → user_subscriptions → packages` والتحقق من حدود الصور/الفيديوهات للمنتج حسب الباقة.
- حدود الباقة (من جدول `packages`) تُطبق في الواجهة عند رفع الصور/الفيديوهات.

### 6.3 التغذية الموحدة والمستويات (tier)

- **الهوك:** `hooks/useUnifiedFeed.ts`
- عند جلب أماكن/منشورات/منتجات يتم ربطها بالباقة عبر:
  - `places.subscription` أو `places.user_subscriptions` → `package` (يحتوي `priority`, `card_style`).
- دالة `getTier(priority, card_style, is_featured)` تحدد:
  - **Premium:** أعلى أولوية أو `card_style === 'premium'` أو `is_featured`.
  - **Gold:** متوسط.
  - **Basic:** افتراضي.
- الترتيب في التغذية: حسب `_tierOrder` ثم التاريخ، بحيث الباقات الأعلى تظهر أولاً.

---

## 7. ملخص سريع

| الجانب | الملفات الرئيسية | الوظيفة |
|--------|-------------------|---------|
| **تعريف الباقة (TypeScript)** | `lib/types.ts` | واجهة `Package` |
| **إدارة الباقات (مدير)** | `app/admin/packages/page.tsx`, `hooks/useAdminManager.ts` | CRUD باقات، عرض جدول، نموذج إضافة/تعديل |
| **عرض واختيار الباقات (عميل)** | `app/dashboard/packages/page.tsx` | عرض الباقات، كود خصم، رفع إيصال، إنشاء اشتراك معلق |
| **مراجعة الاشتراكات (مدير)** | `app/admin/subscriptions/page.tsx` | موافقة/رفض، عرض إيصال |
| **ربط الاشتراك بالمكان** | `app/dashboard/places/new/page.tsx` | التحقق من الاشتراك وحد الأماكن، تعيين `subscription_id` |
| **حدود المنتجات** | `app/dashboard/places/[id]/products/new/page.tsx` | التحقق من حدود الباقة لصور/فيديوهات المنتج |
| **ظهور البطاقات حسب الباقة** | `hooks/useUnifiedFeed.ts`, `components/common/BanCard.tsx` | tier: Premium / Gold / Basic، ترتيب وأسلوب العرض |

---

## 8. توصيات (اختيارية)

1. **إشعار عند الموافقة/الرفض:** استدعاء `send_notification` (إن وُجدت في DB) عند تغيير `user_subscriptions.status` لإعلام المستخدم.
2. **توحيد منطق الخصم:** يمكن نقل التحقق من كود الخصم والتابعين إلى هوك أو دالة مشتركة بين الصفحات إن تعددت.
3. **تأكيد الربط في التغذية:** التأكد من أن كل مكان له `subscription_id` صحيح وأن الاستعلامات تجلب `subscription: user_subscriptions(package: packages(...))` بشكل متسق لضمان ظهور المستويات (Premium/Gold/Basic) بشكل صحيح.
4. **جدول `package_features`:** الهجرة تنشئ جدول ميزات تفصيلية للباقة؛ إن رغبت بواجهة "مقارنة باقات" أو عرض ميزات إضافية، يمكن استغلال هذا الجدول في واجهة الباقات للعميل وفي لوحة المدير.

---

## 9. مراجعة إدارة الباقات (آخر تحديث: 29 يناير 2026)

تمت مراجعة صفحة إدارة الباقات (`/admin/packages`) والهوك `useAdminManager` مع تطبيق التعديلات التالية:

| البند | قبل | بعد |
|--------|-----|-----|
| **تأكيد الحذف** | استدعاء مباشر لـ `Swal.fire` | استخدام `showConfirm` الموحد من SweetAlert |
| **حذف باقة مستخدمة** | فشل من قاعدة البيانات (خطأ عام) | التحقق من وجود اشتراكات مرتبطة ثم عرض رسالة واضحة: "لا يمكن حذف الباقة: مستخدمة في اشتراكات حالية" |
| **قائمة فارغة** | جدول فارغ بدون رسالة | حالة فارغة مع نص "لا توجد باقات" وزر "إضافة باقة جديدة" |
| **حقل نمط الكارت** | `<select>` بدون أنماط الثيم | حدود وخلفية ولون نص من `ThemeContext` مع `rounded-extra-large` |
| **إرسال النموذج** | بدون تغذية راجعة أثناء الحفظ | حالة `submitting` مع تعطيل الأزرار ونص "جاري الحفظ..." |
| **متغير غير مستخدم** | `isDark` من useTheme | إزالة `isDark` |

- **الهوك:** التحقق قبل الحذف في `deletePackage` عبر استعلام عدد السجلات في `user_subscriptions` حيث `package_id = id`؛ إن وُجدت اشتراكات يُرجع `false` مع رسالة مناسبة دون استدعاء `delete`.

---

*تم إعداد التقرير بناءً على مراجعة الكود وقاعدة البيانات في المشروع BANV1.*
